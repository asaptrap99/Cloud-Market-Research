var mobile = false;
var mobileTooltipClose = false;
var smallMobile = false;
var sectionKey={"track listing":"credits",1925:"history",1926:"history",1935:"history",1937:"history",1937:"history",1947:"history",1949:"history",1954:"history",1956:"history",1957:"history",1957:"history",1957:"history",1958:"history",1959:"history",1959:"history",1959:"history",1962:"history",1967:"history",1967:"history",1967:"history",1968:"history",1968:"history",1969:"history",1969:"history",1969:"history",1969:"history",1970:"history",1970:"history",1970:"history",1972:"history",1975:"history",1975:"history",1978:"history",1985:"history",1991:"history",1991:"history",1991:"history",1998:"history",2002:"history",2002:"history",2006:"history",2016:"history",38534:"history",39234:"history",195054:"history",195054:"history",195054:"history",195559:"history",195559:"history",195559:"history",195559:"history",195559:"history",196064:"history",19151917:"history",19241925:"history",19261927:"history",19591967:"history","12lp track listing":"history","1920s":"history","1920s":"history","1950s":"history","1950s and 1960s":"history","1950s and later":"history","1950s jazz standards":"history","1950s jazz standards":"history","1950s jazz standards":"history","1950s jazz standards":"history","1950s jazz standards":"history","1950s jazz standards":"history","1950s jazz standards":"history","1960s":"history","1960s":"history","1960s jazz standards":"history","1960s jazz standards":"history","1970s":"history","1970s and 1980s":"history","1980s":"history","1990s":"history","1999 reissue track listing":"history","2000s":"history","2004 inductees":"history","2009 honorees":"history","2010s":"history",adaptations:"adaptations","admiration among musicians":"influence","album groups":"credits","album information":"credits","album releases":"history",albums:"credits","albums recorded as a sideman":"credits","albums released":"history","albums released in alphabetical order":"history","albums that feature the obxa":"credits",allusions:"influence","allusions to other works":"influence","alphabetical listing by title":"history","also featuring video clips by the following musicians":"credits","amplifier basics":"influence",appearances:"credits",art:"influence","artistic career":"life and career",artistry:"influence","artistry and influences":"influence","artists and associated acts and credits":"life and career","artists produced":"life and career","as a jazz standard":"credits","as jazz standard":"credits","as sideman":"credits","associated musicians":"history",authorship:"credits",background:"influence","background and production":"influence","background and production":"history","background and recording":"history","background and reviews":"history","band alumni":"life and career","band history":"life and career","band members":"life and career",bandleader:"life and career","beat culture":"history","beauty came to us in stone":"influence",beginnings:"influence","big band era":"life and career",biography:"life and career","biography and career":"life and career","biography and works":"life and career","bird and dizzy":"history","blue note era":"life and career","bluesrock and jazz fusion era":"life and career","bohemian lifestyle":"life and career","box sets":"credits","brew masters":"influence","brian brown quintet":"influence",broadcasting:"life and career","business career 19581963":"life and career","career":"life and career","career and legacy":"life and career","career as musician":"life and career","career highlights":"life and career","career history":"life and career","career overview":"life and career",cast:"credits","cd and track listing":"credits","cd version of the complete concert":"credits",characteristics:"influence","childhood and early career":"life and career","chord progression":"influence",collaborations:"life and career","collaborations az":"credits","collective personnel":"credits",composition:"influence",composingarranging:"influence","compilation albums":"credits","composition and inspiration":"influence","composition and production":"influence","composition work":"influence",compositions:"influence",content:"influence",contents:"influence",contributors:"credits",creation:"influence",credits:"credits","cultural references":"influence","cultural significance and influence":"influence",culture:"influence","culture and lifestyles":"influence","culture and sights":"influence","current projects":"influence","david letterman":"life and career",deaths:"history","definition and characteristics":"influence",design:"influence",development:"influence","development in the 21st century":"influence",discography:"life and career","diversification and popularization":"history","double bass":"influence","early career":"life and career","early career 196373":"life and career","early days":"influence","early life":"influence","early life  influences":"influence","early life and career":"influence","early life and education":"influence","early life and family":"influence","early life and influences":"influence","early life and work":"influence","early life education and early career":"influence","early notoriety in the us":"life and career","early playing career":"life and career","early radio career":"life and career","early recordings 19441954":"life and career","early solo career":"life and career","early success":"life and career","early uses":"history","early work":"influence","early years":"influence","education and career":"history","eightvolume vinyl set":"credits","electric bass players":"history",events:"history",examples:"influence","examples of artists who have been associated with space music":"influence","examples of quartal pieces":"influence","family influence and early music history":"influence","famous players":"influence","featured artists":"credits","featuring the following musicians":"credits","festival history":"history","festival lineups":"history",festivals:"history","fillmore east recording":"influence","fillmore east years":"history","fine art career":"influence","first paragraph":"opening section","for john cage":"influence",Minor_scale:"influence","harvard and world war ii":"influence","historical usage of the term":"influence","history and style":"influence","history of the band":"history","identity of tsf jazz":"history","in jazz":"history","in music":"influence","in popular culture":"influence","in popular music":"influence",inductees:"influence",inductees:"influence",influences:"influence","influences and contributions":"influence","influential recordings":"influence","inspiration and relationships":"influence","inspiration and writing":"influence","inspirations and song analysis":"influence",interests:"influence",introduction:"life and career",j:"influence",jazz:"history","jazz career":"life and career","jazz influences":"influences","jazz recordings":"life and career","jazz with the blues":"history","july 14 1964 tuesday":"history","key members":"life and career","konkani music":"influence","label work":"life and career","later career":"life and career","later jazz and us session work":"life and career","later life and career":"life and career","later period":"life and career","later versions":"credits",legacy:"influence","legacy and influence":"influence","legacy and renditions":"influence","legacy edition 2006":"influence",life:"life and career","life  career":"life and career","life and music":"life and career","life and work":"life and career","life and works":"life and career","life and writings":"life and career","list of recording sessions":"credits","literary career":"life and career","live recordings":"credits","marriage to miles davis":"life and career","miles davis":"history","music":"life and career","music and business":"life and career","music and lyrics":"life and career","music career":"life and career","music theory":"life and career","musical approach":"influence","musical artists":"history","musical background":"history","musical beginning":"influence","musical career":"life and career","musical features":"influence","musical influences":"influence","musical influences and style":"influence","musical influencestechniques":"influence","musical life":"life and career","musical style":"influence","musical style and commercial approach":"influence","musical style and influence":"influence","musical style and influences":"influence","musical style writing composition":"life and career","musical styles":"influence",musicians:"credits","new york career":"life and career","notable alumni":"history","notable drug users":"history","notable events":"history","notable gatefold releases":"history","notable horn players":"influence","notable past performers":"history","notable people":"history","notable performances and recordings":"history","notable performers":"history","notable performers and performances":"history","notable quintets":"influence","notable recordings":"credits","notable users":"history","partial discography":"life and career",participants:"credits","past performers":"history",people:"history","performance affiliations":"history",performances:"credits",performers:"credits","performers by song":"credits","personal life":"influence",personality:"influence",personnel:"credits","personnel and recording dates":"credits","personnel tracks 13 july 5 1969 at the newport jazz festival":"credits","personnel tracks 49 august 29 1970 at the isle of wight festival":"credits",photography:"life and career",players:"credits",plot:"influence","plot summary":"influence","poet and playwright":"influence","pop culture references":"influence","popular culture":"influence","popular music":"influence","postcombo audio years":"life and career","postwar paris 19462000":"history","postwar period and the 1950s":"history","postworld war ii jazz":"history","print advertisements":"influence",production:"credits","production equipment and style":"credits","production history":"credits",productions:"influence","productive as ever":"influence","professional career":"life and career",progression:"influence",promotion:"influence",promotion:"influence","reception and influence":"influence","recorded versions":"credits","recorded work":"life and career",recording:"influence","recording and production":"influence","recording career":"influence","recording details":"credits","recording history":"credits","recording session":"credits","recording sessions":"credits","recording sessions and personnel":"credits",recordings:"credits","recordings and compositions":"credits","recordings and covers":"credits",reharmonization:"influence","release and reception":"credits","release information":"credits",releases:"credits","releases since the bands breakup":"life and career",renditions:"credits",samples:"influence",santana:"influence","selected discography":"life and career","selected works":"life and career","solo career":"influence","solo piano":"influence","solo work":"influence",songs:"credits","songs based on how high the moon":"credits","songs performed":"credits","songs referring to hand jive":"credits","songwriting career":"credits",sound:"influence","sound and influence":"influence","sound and influences":"influence",soundtrack:"credits","soundtrack and score":"credits",storylines:"influence","struggle and revival":"life and career","studio years 1950s1970s":"life and career",style:"influence","style and influences":"influence","style and reception":"influence","style and legacy":"influence","style and songwriting":"influence","style and work":"influence",styleinfluence:"influence","subject matter":"influence","success layla at fillmore east":"influence","taxonomic history":"influence",technique:"influence","technique and style":"influence",television:"history","television career":"history","the 1960s and 70s":"history","the basie years":"life and career","the early minor quintet":"influence","the original birdland 194965":"history","the project":"influence","the terrie williams agency":"life and career","the three charlie parker recordings":"credits","the us":"history","theme song":"credits",timeline:"influence","title and themes":"influence","title references":"influence","track list":"credits","track listing":"credits","track listing cd":"credits","track listing of the original lp":"credits","track listings":"credits",tracklist:"credits",tracks:"credits","tracks listing":"credits",trivia:"influence",types:"influence",usage:"history","use in jazz":"history","use in music":"influence",variants:"influence","venturing into music":"life and career","wahwah in trumpet and trombone playing":"influence","what i say":"influence","with the flaming lips":"influence",work:"life and career",works:"influence"};
var milesPages = [2,3,34,57,99,132,152,154,159,162,163,166,170,183,198,202,229,239,242,247,250,254,260,275,276,281,292,295,309,322,323,333,334,345,347,351,352,360,366,368,380,383,384,385,387,388,396,397,398,401,402,404,406,425,462,473,499,503,507,509,531,533,540,554,577,580,586,589,595,598,612,615,616,628,632,649,664,666,680,682,685,686,687,718,742,745,746,749,750,751,755,764,765,767,775,777,786,809,811,815,853,856,857,858,874,901,906,909,981,989,995,1005,1015,1016,1032,1036,1042,1050,1059,1072,1075,1077,1081,1084,1087,1089,1095,1098,1120,1122,1126,1128,1131,1151,1162,1164,1186,1187,1225,1252,1255,1304,1310,1314,1315,1316,1328,1332,1345,1352,1358,1372,1373,1402,1406,1408,1416,1428,1430,1438,1451,1452,1453,1457,1461,1487,1491,1500,1506,1517,1520,1529,1531,1545,1572,1582,1585,1676,1701,1704,1713,1729,1730,1744,1754,1772,1787,1805,1824,1838,1858,1866,1874,1883,1885,1886,1887,1888,1889,1890,1892,1893,1894,1898,1899,1903,1904,1907,1908,1909,1911,1913,1914,1915,1919,1921,1922,1924,1927,1930,1933,1943,1947,1954,1958,1976,2001,2002,2018,2029,2046,2049,2070,2100,2111,2133,2135,2136,2137,2141,2145,2150,2151,2155,2169,2185,2193,2210,2211,2269,2273,2275,2283,2295,2298,2300,2329,2335,2339,2347,2374,2378,2384,2391,2398,2412,2427,2428,2441,2451,2452,2468,2469,2470,2485,2489,2504,2510,2518,2529,2531,2537,2539,2542,2543,2548,2572,2582,2585,2638,2647,2657,2785,2795,2821,2822,2826,2827,2841,2842,2845,2846,2847,2848,2849,2868,2890,2912,2924,2965,2998,3013,3032,3056,3060,3068,3074,3097,3100,3106,3749,3766,3768,3776,3781,3785,3787,3990,3994,4006,4011];
var milesPageIdKey;
var commaFormat = d3.format("0,000");
var percentFormat = d3.format(".0%");
var entityTypeCounts;
var sectionHeaderNames = [];
var entityTypes = []//["musicians", "works", "people", "genres", "events", "places", "companies", "other"];
var visScrollEvents = [];
var proseLinkContainer = false;
var canvasObject;

var visualisations = [];
var numVisualisations = 2;

var sectionScrollProgress = 0;

var layoutType = [ "bubble", /*"picture", "grid",*/ "decade"/*, "decade_split"*/];
var layoutIndex = 0;

var chartWidth = 600;
var chartHeight = 200;

var bubbleWidth = 500;
var bubbleHeight = 500;

var numPerColumn = 60;
var nodeHeight = 4;
var padding = 1;
var minYear;
var isPicture = false;

var scrollEntityTypePosition = null;
var scrollSectionHeader = null;

viewportWidth = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
viewportHeight = Math.max(document.documentElement.clientHeight, window.innerHeight || 0);

if( /Android|webOS|iPhone|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ) {
	mobile = true;
	if (viewportWidth < 375) { smallMobile = true; };
}

if(!mobile){
	var controller = new ScrollMagic.Controller();
}



d3.csv("mentions6.csv", function(error, milesMentionsData) {
	d3.csv("pages13.csv", function(error, milesPagesData) {
		d3.csv("point_coor.csv", function(error, pictureCoords) {

	canvasObject = pictureCoords;

function d3_layout_packSort(a, b) {
	return parseInt(b.PageViews) - parseInt(a.PageViews);
};

var PageViewScale = d3.scale.linear().domain([1,4062937]).range([1,4000]).clamp(true)
var mostConnectedScale = d3.scale.linear().domain([1, 574]).range([1,4000]).clamp(true)

var ease = d3.ease('cubic-in-out');

var timeScale = d3.scale.linear()
	.domain([0, 1000])
	.range([0,1]);

var decadeTypeLabels = [];

function drawDataBinding() {

	for(var x = 1; x <= numVisualisations; x++) {
		var layoutMode = "";

		var chartNumber = x;

		if(x === 1){
			layoutMode = "bubble";
		} else if (x === 2){
			layoutMode = "decade"
		}

		var base = d3.select("#vis-" + x)
		;

		base
			.on("touchstart",function(d,i){
				var parent = d3.select(this).attr("class");
				if(parent.indexOf("first") > -1 && mobile && mobileTooltipClose){
					d3.select(".tooltip-container-one").classed("hidden",true);
				}
				else if(parent.indexOf("second") > -1 && mobile && mobileTooltipClose){
					d3.select(".tooltip-container-two").classed("hidden",true);
				}
			})
			.on("mousemove",function(d,i){
				if(!mobile){
					var coordinates = d3.mouse(this);
					var parent = d3.select(this).attr("class");
					if(parent.indexOf("first") > -1){
						if(!d3.select(".tooltip-container-one").classed("hidden")){
							d3.select(".tooltip-container-one")
								.style("top",function(d){
									return coordinates[1] + 20 + "px";
								})
								.style("left",function(d){
									return coordinates[0] + 20 + "px";
								})
								;
						}
					}
					else{
						if(!d3.select(".tooltip-container-two").classed("hidden")){
							d3.select(".tooltip-container-two")
								.style("top",function(d){
									return coordinates[1] + 20 + "px";
								})
								.style("left",function(d){
									return coordinates[0] + 20 + "px";
								})
								;
						}
					}
				}
			})
			;

		var tooltip = base.append("div")
		  .attr("class", function(){
				if(x==1){
					return "tooltip-container tooltip-container-one tk-neuzeit-grotesk hidden"
				}
				return "tooltip-container tooltip-container-two tk-neuzeit-grotesk hidden"
			})
			;

		var sectionClass = {"life and career":"life-section","history":"history-section","opening section":"opening-para-section","credits":"credits-section","influence":"influence-section"};
		var subjectClass = {"books":"books-subject","works":"works-subject","films":"films-subject","genres":"genres-subject","recording":"recordings-subject","musicians":"people-subject","people":"people-subject","places":"places-subject","events":"events-subject","other":"other-subject"};

		if (x==2){

			var yearRandom = d3.scale.linear().domain([0,1]).range([1955,2012])

			var secondChartData = milesPagesData.filter(function(d,i){
				return d.year != "" && d.year != null;
			})
			;
			var preFortyCount = 0;

			var secondDataYearNest = d3.nest().key(function(d) {
				if(d.year < 1935){
					preFortyCount++;
					// return null;
					return 1934;
				}
				if(mobile){
					if(+d.year % 2 != 0){
						return +d.year+1
					}
				}
				return d.year;
			})
			.entries(secondChartData)
			;

			var minYear = d3.min(secondDataYearNest, function(d) { return +d.key });
			var maxYear = d3.max(secondDataYearNest, function(d) { return +d.key });
			var maxCount = d3.max(secondDataYearNest, function(d) { return +d.values.length });
			var chartHeight = maxCount*6;
			var originalChartHeight = chartHeight;
			var secondDataObject = [];
			var width = (maxYear-minYear)*8
			if(mobile){
				width = width/2;
			}
			var offset = 0;
			var count = 0;
			var itemWidth = 139;
			var columnWidth = 8;
			if(smallMobile){
				columnWidth = 7;
			}

			//
			for (var year in secondDataYearNest){
				var yearData = secondDataYearNest[year].key;



				var xPos = columnWidth*(secondDataYearNest[year].key - minYear)+offset;

				if(mobile){
					xPos = (columnWidth*(secondDataYearNest[year].key - minYear)/2)+offset;
				}
				var yPos;
				var id;
				var nestCount;

				for (page in secondDataYearNest[year].values){

					id = secondDataYearNest[year].values[page].id
					nestCount = count++;
					yPos = chartHeight - page*6;
					if(milesPageIdKey.has(id)){
						secondDataObject.push({x:xPos,y:yPos,id:id,pageData:milesPageIdKey.get(id).values[0],nestCount:nestCount})
					}
				}
			}

			function secondChartPos(sectionFilter){

				if(sectionFilter=="all sections"){
					objectFilter = secondChartData;

					var filterDataObject = objectNonMatchArray(objectFilter);

					circlesData = circlesData.data(filterDataObject,function(d){
						return d.id;
					})
					;

					circlesData
						.classed("section-filtered",function(d,i){
							if(d.match){
								return true;
							}
							return false;
						})
						.transition().duration(600)
						.delay(function(d,i){
							return i*2;
						})
						.style("top", function(d, i) {
							if(d.match){
								return (+d.y+originalChartHeight+30) + "px";
							}
							return (+d.y) + "px";
						})
						;

				}
				else{
					var objectFilter = secondChartData.filter(function(d,i){
						var itemSectionArray = d.mentionArray;
						var match = 0;
						for (var section in itemSectionArray){
							var sectionName = itemSectionArray[section].sectionHeader
							if(itemSectionArray[section].sectionHeader in sectionKey){
								sectionName = sectionKey[itemSectionArray[section].sectionHeader];
							}
							if(sectionName == sectionFilter){
								match = 1;
							};
						}
						return match == 1;
					})
					;

					var objectNonFilter = secondChartData.filter(function(d,i){
						var itemSectionArray = d.mentionArray;
						var match = 0;
						for (var section in itemSectionArray){
							var sectionName = itemSectionArray[section].sectionHeader
							if(itemSectionArray[section].sectionHeader in sectionKey){
								sectionName = sectionKey[itemSectionArray[section].sectionHeader];
							}
							if(sectionName == sectionFilter){
								match = 1;
							};
						}
						return match == 0;
					})
					;
					var filterDataObject = objectMatchArray(objectFilter).concat(objectNonMatchArray(objectNonFilter));

					circlesData = circlesData.data(filterDataObject,function(d){
						return d.id;
					})
					;

					circlesData
						.classed("section-filtered",function(d,i){
							if(d.match){
								return true;
							}
							return false;
						})
						.transition().duration(600)
						.delay(function(d,i){
							return i*2;
						})
						.style("top", function(d, i) {
							if(d.match){
								return (+d.y+originalChartHeight+30) + "px";
							}
							return (+d.y) + "px";
						})
						;

				}

				function objectMatchArray (dataArray){

					var secondDataYearNest = d3.nest().key(function(d) {
						if(d.year < 1935){
							preFortyCount++;
							// return null;
							return 1934;
						}
						if(mobile){
							if(d.year % 2 != 0){
								return +d.year+1
							}
						}
						return d.year;
					})
					.entries(dataArray)
					;

					var minYear = d3.min(secondDataYearNest, function(d) { return +d.key });
					var maxYear = d3.max(secondDataYearNest, function(d) { return +d.key });
					var maxCount = d3.max(secondDataYearNest, function(d) { return +d.values.length });
					var chartHeight = maxCount*6;
					var filterDataObject = [];
					var width = (maxYear-minYear)*8
					var offset = 0;
					var count = 0;
					var itemWidth = 139;
					//
					for (var year in secondDataYearNest){
						var yearData = secondDataYearNest[year].key;

						var xPos = 8*(secondDataYearNest[year].key - minYear)+offset;
						if(mobile){
							xPos = 8*(secondDataYearNest[year].key - minYear)/2+offset;
						}
						var yPos;
						var id;
						var nestCount;

						for (page in secondDataYearNest[year].values){
							id = secondDataYearNest[year].values[page].id
							nestCount = count++;
							yPos = page*6;
							filterDataObject.push({x:xPos,y:yPos,id:id,pageData:milesPageIdKey.get(id).values[0],nestCount:nestCount,match:1})
						}
					}
					return filterDataObject;
				}

				function objectNonMatchArray (dataArray){

					var secondDataYearNest = d3.nest().key(function(d) {
						if(d.year < 1935){
							preFortyCount++;
							// return null;
							return 1934;
						}
						if(mobile){
							if(d.year % 2 != 0){
								return +d.year+1
							}
						}
						return d.year;
					})
					.entries(dataArray)
					;

					var minYear = d3.min(secondDataYearNest, function(d) { return +d.key });
					var maxYear = d3.max(secondDataYearNest, function(d) { return +d.key });
					var maxCount = d3.max(secondDataYearNest, function(d) { return +d.values.length });
					// var chartHeight = originalChartHeight;
					var filterDataObject = [];
					var width = (maxYear-minYear)*8
					var offset = 0;
					var count = 0;
					var itemWidth = 139;
					//
					for (var year in secondDataYearNest){
						var yearData = secondDataYearNest[year].key;

						var xPos = 8*(secondDataYearNest[year].key - minYear)+offset;
						if(mobile){
							xPos = 8*(secondDataYearNest[year].key - minYear)/2+offset;
						}
						var yPos;
						var id;
						var nestCount;

						for (page in secondDataYearNest[year].values){
							id = secondDataYearNest[year].values[page].id
							nestCount = count++;
							yPos = originalChartHeight - page*6;
							filterDataObject.push({x:xPos,y:yPos,id:id,pageData:milesPageIdKey.get(id).values[0],nestCount:nestCount, match:0})
						}
					}
					return filterDataObject;
				}

			}

			var circlesData = base.append("div")
				.attr("class",function(d){
					return "second-chart-data";
				})
				.style("height",maxCount*6+10+"px")
				.selectAll("div")
				.data(secondDataObject,function(d){
					return d.id;
				})
				;

			var circlesAppend = circlesData
	  		.enter()
				.append("div")
				.attr("class", function(d,i){
					var classString = " ";
					var sectionPresent = {};
					var itemSectionArray = d.pageData.mentionArray;

					for (var section in itemSectionArray){

						var sectionName = itemSectionArray[section].sectionHeader;

						if(sectionName in sectionKey){
							sectionName = sectionKey[sectionName];
						}
						if(sectionName in sectionClass){
							sectionPresent[sectionName] = 1;
						}
					}

					for (var item in Object.keys(sectionPresent)){
						classString = classString + " " + sectionClass[Object.keys(sectionPresent)[item]];
					}
					return "node-second-chart" + classString;
					// return "node-second-chart";
				})
				.style("position", "absolute")
		  	.style("left", function(d, i) {
					if(d.pageData.year > 1934){
						return (+d.x+6)+ "px";
					}
					return d.x + "px";
		  	})
				.style("top", function(d, i) {
					return d.y + "px";
				})
				.on("mouseover", function(d){
					if(!mobile){
						var data = d;
						var item = d3.select(this);
						var elem = d3.select(".tooltip-container-two")
						showTooltip(data,item,elem);
					}
				})
				.on("mouseout", function(d){
					if(!mobile){
						d3.select(".tooltip-container-two")
						.classed("hidden",true)
						.selectAll(".tooltip-content").remove()
						;
					}
				})
				.on("click",function(d){
					if(!mobile){
						//window.location.href = "https://en.wikipedia.org/wiki/"+d.pageData.URL;
						window.open("https://en.wikipedia.org/wiki/"+d.pageData.URL, '_blank');
					}
				})
				.on("touchstart",function(d){
					if(mobile){
						mobileTooltipClose = false;
						setTimeout(function(){ mobileTooltipClose = true; }, 200);

						d3.select(".tooltip-container-two")
						.classed("hidden",true)
						.selectAll(".tooltip-content").remove()
						;

						var data = d;
						var item = d3.select(this);
						var elem = d3.select(".tooltip-container-two")
						showTooltip(data,item,elem);
					}
				})
				;

			var secondChartAxis = d3.select("#vis-2")
				.append("div")
				.attr("class","second-chart-axis tk-neuzeit-grotesk")
				;

			secondChartAxis
				.append("div")
				.attr("class","second-axis-container-wrapper")
				.style("width",function(){
					if(mobile){
						if(smallMobile){
							return 81/2*7+"px";
						}
						return 81/2*8+"px";
					}
					return "100%"
				})
				.selectAll("div")
				.data(d3.range(1935,2017,10))
				.enter()
				.append("div")
				.attr("class","second-chart-axis-item")
				.text(function(d,i){
					return d;
				})
				;

			var secondChartAxisPre = secondChartAxis.append("div")
				.attr("class","second-chart-axis-pre")
				.style("height",(preFortyCount*6+10)+"px")
				.append("p")
				.attr("class","second-chart-axis-pre-text")
				.html("Pre<br>1935")
				;

			var secondChartAxisDeath = secondChartAxis.append("div")
				.attr("class","second-chart-axis-death")
				// .style("bottom",preFortyCount*6+"px")
				.append("p")
				.attr("class","second-chart-axis-death-text")
				.html("Miles' Death")
				;

			var secondChartAxisBlue = secondChartAxis.append("div")
				.attr("class","second-chart-axis-blue")
				// .style("bottom",preFortyCount*6+"px")
				.append("p")
				.attr("class","second-chart-axis-blue-text")
				.html("Kind of Blue")
				;

			var secondChartAxisSounds = secondChartAxis.append("div")
				.attr("class","second-chart-axis-sounds")
				// .style("bottom",preFortyCount*6+"px")
				.append("p")
				.attr("class","second-chart-axis-sounds-text")
				.html("The New Sounds")
				;

			var secondChartAxisBrew = secondChartAxis.append("div")
				.attr("class","second-chart-axis-brew")
				// .style("bottom",preFortyCount*6+"px")
				.append("p")
				.attr("class","second-chart-axis-brew-text")
				.html("Bitches Brew")
				;

		} else{

			var adjust = .5;
			var adjustTwo = .8;
			var adjustThree = 1;
			var radiusSvgScale = d3.scale.linear().domain([6,30]).range([.4,1]);

			var circles = base.append("svg")
				.attr("class",function(d){
					return "first-chart-data first-chart-colored";
				})
				.attr("viewBox",function(){
					if(mobile){
						return "5 0 450 600";
					}
					return null;
				})
				.append("g")
				.attr("transform",function(){
					return "translate(0,-50)"
				})
				.selectAll("circle")
				.data(milesPagesData)
				.enter()
				.append("circle")
				.attr("class", function(d){
					if(subjectClass[d.subjectRemapping] == null){
					}
					return "first-chart-nodes " + subjectClass[d.subjectRemapping];
				})
				.style("fill-opacity",function(d,i){
					return radiusSvgScale(d.radius);
				})
				.attr("r", function(d, i) {
					if(d.radius<3){
						return d.radius*adjust;
					}
					else if(d.radius>15){
						return d.radius*adjustThree;
					}
					else if(d.radius>3){
						return d.radius*adjustTwo;
					}
					return d.radius;
				})
				.attr("cx", function(d, i) {
					if(mobile){
						return +d.x-70;
					}
					if(+d.x2>250){
						return (+d.x2*.9+100);
					}
					return (+d.x2*1.05+100);
				})
				.attr("cy", function(d, i) {
					if(mobile){
						return +d.y-70;
					}
					return (d.y2*2-300);
				})
				.classed("linked-from-miles",function(d){
					if(d.linked_from_miles == true){
						return true;
					}
					return false;
				})
				.on("mouseover", function(d){
					if(!mobile){
						var data = d;
						var item = d3.select(this);
						var elem = d3.select(".tooltip-container-one")
						showTooltip(data,item,elem);
					}
				})
				.on("mouseout", function(d){
					if(!mobile){
						d3.select(".tooltip-container-one")
						.classed("hidden",true)
						.selectAll(".tooltip-content").remove()
						;
					}
				})
				.on("click",function(d){
					if(!mobile){
						window.open("https://en.wikipedia.org/wiki/"+d.URL, '_blank');
					}
				})
				.on("touchstart",function(d){
					if(mobile){
						mobileTooltipClose = false;
						setTimeout(function(){ mobileTooltipClose = true; }, 200);

						d3.select(".tooltip-container-one")
						.classed("hidden",true)
						.selectAll(".tooltip-content").remove()
						;

						var data = d;
						var item = d3.select(this);
						var elem = d3.select(".tooltip-container-one")
						showTooltip(data,item,elem);
					}
				})
				;

			var textFirstChart = d3.select(".first-chart-data")
				.append("g")
				.attr("transform",function(){
					return "translate(0,-50)"
				})
				.selectAll("text")
				.data(milesPagesData.filter(function(d,i){
					return d.radius > 14 && +d.id != 1531 && +d.id != 1252 && +d.id != 2100;
				}))
				.enter()
				.append("text")
				.attr("class", function(d){
					return "first-chart-text tk-neuzeit-grotesk";
				})
				.style("fill", function(d, i) {
					if(+d.radius>40){
						return "black";
					}
					return null;
				})
				.attr("x", function(d, i) {
					if(mobile){
						if(d.name.split(" ").length<2){
							return (+d.x - 70);
							// return 10;
						}
						// return null;
					}
					if(d.name.split(" ").length<2){
						if(+d.x2>250){
							return (+d.x2*.9+100);
						}
						return (+d.x2*1.05+100);
					}
					return null;
				})
				.attr("y", function(d, i) {
					if(mobile){
						return +d.y - 71;
					}
					return (d.y2*2-300);
				})

			if(mobile){
				textFirstChart.text(function(d){
					if(d.name.split(" ").length<2){
						return d.name;
					}
					return null;
				})
				;

				textFirstChart
					.filter(function(d){
						return d.name.split(" ").length > 1;
					})
					.selectAll("tspan")
					.data(function(d){
						return d.name.split(" ");
					})
					.enter()
					.append("tspan")
					.attr("x",function(d,i){
						return d3.select(this.parentNode).datum().x - 70;
					})
					.attr("dy",function(d,i){
						if(i==1){
							return "1.2em"
						}
						return null;
					})
					.attr("width","100")
					.attr("text-anchor","middle")
					.text(function(d,i){
						return d;
					})
					;
			}

			if(!mobile){
				textFirstChart
					.html(function(d){
						if(+d.x2>250){
							var x = (+d.x2*.9+100);
						}
						else{
							var x = (+d.x2*1.05+100);
						}
						if(d.name.split(" ").length>1){
							return "<tspan x="+x+" text-anchor='middle'>"+d.name.split(" ")[0]+"</tspan><tspan x="+x+" text-anchor='middle' dy='1.2em'>"+d.name.split(" ")[1]+"</tspan>"
						}
						return d.name;
					})
					;
			}

		}

			function drawFilters(){
				if(x==1){

						var entityTypeFilters = [
							{
								name: "Mentioned on Miles Davis' page",
								highlight: function(d) { return d.linked_from_miles }
							}, {
								name: "Miles Davis Work",
								highlight: function(d) { return d.miles_work }
							}, {
								name: "Recordings",
								highlight: function(d) { return d.subject === "recording" }
							}, {
								name: "People/Musicians",
								highlight: function(d) { return ["people", "musicians"].indexOf(d.subject) !== -1}
							}, {
								name: "Places",
								highlight: function(d) { return d.subject === "places" }
							}, {
								name: "Other",
								highlight: function(d) { return ["other", "books", "works", "films", "genres"].indexOf(d.subject) !== -1 }
							}
						];

						var filterData = entityTypeFilters.filter(function(d,i){
							return i > 1;
						});

						filterData.unshift({"name":"all pages"});
						var subjectFilterMap = {"events":"events-subject","other":"other-subject","recording":"recordings-subject","people":"people-subject","People/Musicians":"people-subject","Recording":"recordings-subject","Recordings":"recordings-subject","Places":"places-subject","Other":"other-subject"};
						var firstChartFilters = d3.select(".first-chart-container").select(".filter-items")
							.selectAll("div")
							.data(filterData)
							.enter()
							.append("div")
							.attr("class",function(d,i){
								var className = subjectFilterMap[d.name];

								if(i==0){
									return "first-chart-filter highlighted-filter "+className;
								}
								return "first-chart-filter "+className;
							})
							.attr("data-entity-type-filter-index",function(d,i){
								return i;
							})
							.text(function(d,i){
								if(d.name == "People/Musicians"){
									return "people";
								}
								return d.name;
							})
							.on("click",function(d){
								d3.selectAll(".first-chart-filter").classed("highlighted-filter",false)
								d3.select(this).classed("highlighted-filter",true)
								var className = subjectFilterMap[d.name];
								for (var item in filterData){
									d3.select(".first-chart-data").classed("filtered-"+subjectFilterMap[filterData[item].name],false).classed("filtered-miles-work",false);
								}
								d3.select(".first-chart-data").classed("filtered-"+className,true).classed("filtered-miles-work",false);
							})
							;

							var totalItems = milesPagesData.length;

							d3.select(".first-chart-prose-breakdown")
								.selectAll("p")
								.data(entityTypeCounts)
								.enter()
								.append("p")
								.attr("class",function(d,i){
									return "first-chart-prose-breakdown-item "+subjectFilterMap[d.key]
								})
								.html(function(d){
									var title = d.key;
									if(d.key == "recording"){
										title = "recordings";
										return "<span class='capitalize'>"+title+"</span> - " + d.values + " pages, " + percentFormat(d.values/totalItems) + " of total";
									}
									if(d.key == "other"){
										title = "Everything Else";
										return "<span class='capitalize'>"+title+"</span> - " + d.values + " pages, " + percentFormat(d.values/totalItems) + " of total, which includes everything from a <a class='prose-link' href='https://en.wikipedia.org/wiki/Dogfish_Head_Brewery'>beer named after Miles</a> to the entry for the <a class='prose-link' href='https://en.wikipedia.org/wiki/Space_music'>Space Music</a> genre";
									}
									return "<span class='capitalize'>"+title+"</span> - " + commaFormat(d.values) + " pages, " + percentFormat(d.values/totalItems) + " of total";
								})
								;

						var searchArray = [];
						var searchResults = d3.select(".search-results-one");
						var searchResultMouseOver = false;

						function keyUpThing(text) {
							searchFilmColumnTwo(text.value.trim());
						}

						function searchFilmColumnTwo(value) {
							console.log(value);
							if (value.length > 2) {
								searchResults.style("display","block");
								var re = new RegExp("\\b" + d3.requote(value), "i");
								searchArray = _.filter(milesPagesData, function(d,i) {
									return re.test(d.name);
								}).slice(0,100)
								;

								var searchDivData = searchResults.selectAll("p")
									.data(searchArray, function(d){
										return d.id;
									})
									;

								var searchEnter = searchDivData
		              .enter()
		              .append("p")
		              .attr("class","search-result")
		              .html(function(d){
		                return d.name;
		              })
		              .on("click",function(d){
										var data = d;
										d3.select(".first-chart-data").classed("searching",true);
										d3.selectAll(".first-chart-nodes").filter(function(d){
											return d.id == data.id;
										}).classed("search-match",true)
										var item = d3.select(this);
										var elem = d3.select(".tooltip-container-one")
										showTooltip(data,item,elem);
		                searchResults.style("display","none");
										mobileTooltipClose = true;
		              })
		              ;

								searchDivData.exit().remove();
							}
							else{
								searchResults.style("display","none");
								d3.select(".first-chart-data").classed("searching",false);
								d3.selectAll(".first-chart-nodes").classed("search-match",false);
								d3.select(".tooltip-container-one").classed("hidden",true);

							}
						}

						var searchInput = d3.selectAll(".search-input-one").on("keyup", function(){
							keyUpThing(this);
						});

				}
				else if(x==2){

					var searchData = milesPagesData.filter(function(d,i){
						return d.year != "" && d.year != null;
					})
					;

					var filterItemsTwo = Object.keys(sectionClass);
					filterItemsTwo.unshift("all sections");

					d3.select(".second-chart-container").select(".filter-items")
						.selectAll("p")
						.data(filterItemsTwo)
						.enter()
						.append("p")
						.attr("class",function(d,i){
							if(i==0){
								return "second-chart-filter highlighted-filter"
							}
							return "second-chart-filter"
						})
						.text(function(d){
							return d;
						})
						.on("click",function(d){

							secondChartPos(d);

							d3.selectAll(".second-chart-filter").classed("highlighted-filter-two",false)
							d3.selectAll(".second-chart-filter").classed("highlighted-filter",false)

							if(d=="all sections"){
								d3.select(this).classed("highlighted-filter",true);
							}
							else{
								d3.select(this).classed("highlighted-filter-two",true);
							}
						})
						;

					d3.select(".second-chart-container")
						.on("touchend",function(){
							if(mobile && mobileTooltipClose){
								d3.select(".tooltip-container-two").classed("hidden",true);
							}
						})

					d3.select(".second-chart-prose-breakdown")
						.selectAll("p")
						.data(Object.keys(sectionClass))
						.enter()
						.append("p")
						.attr("class","second-chart-prose-breakdown-item")
						.html(function(d,i){
							var title = d;
							var count = d3.selectAll("."+sectionClass[d]).size();
							if(i==0){
								return "<span class='capitalize'>"+title+"</span> - " + count + " pages with at least one mention in this context";
							}
							return "<span class='capitalize'>"+title+"</span> - " + count + " pages"
						})
						;

					if(!mobile){
						var influenceSection = new ScrollMagic.Scene({
								triggerElement: ".trigger-influence-section",
								duration:150,
								triggerHook:.5,
								offset:0
							})
							// .addIndicators({name: "influence"}) // add indicators
							.addTo(controller)
							.on("enter", function (e) {
								if(e.target.controller().info("scrollDirection") == "FORWARD"){
									secondChartPos("influence");
									d3.selectAll(".second-chart-filter").classed("highlighted-filter-two",false).classed("highlighted-filter",false)
										.filter(function(d,i){
											return i==5;
										})
										.classed("highlighted-filter-two",true)
										;
									d3.select(".influence-highlight").style("color","rgb(72, 220, 124)");
								}
								else{
								}
							})
							.on("leave",function(e){
								if(e.target.controller().info("scrollDirection") == "FORWARD"){
								}
								else{
									secondChartPos("all sections");
									d3.selectAll(".second-chart-filter").classed("highlighted-filter-two",false).classed("highlighted-filter",false)
										.filter(function(d,i){
											return i==0;
										})
										.classed("highlighted-filter",true)
										;
									d3.select(".influence-highlight").style("color",null);
								}
							})
							;
					}


					var searchArray = [];
					var searchResults = d3.select(".search-results-two");
					var searchResultMouseOver = false;

					var searchInput = d3.selectAll(".search-input-two")
						.on("keyup", function(){
							keyupedFilmColumn(this);
						});

					function keyupedFilmColumn(text) {
						searchFilmColumn(text.value.trim());
					}

					function searchFilmColumn(value) {
						if (value.length > 2) {

							searchResults.style("display","block");
							var re = new RegExp("\\b" + d3.requote(value), "i");
							searchArray = _.filter(searchData, function(d,i) {
								return re.test(d.name);
							}).slice(0,100)
							;

							var searchDivData = searchResults.selectAll("p")
								.data(searchArray, function(d){
									return d.id;
								})
								;

							var searchEnter = searchDivData
								.enter()
								.append("p")
								.attr("class","search-result")
								.html(function(d){
									return d.name;
								})
								.on("click",function(d){
									d3.select(".second-chart-data").classed("searching",true);
									var data = d;
									d3.selectAll(".node-second-chart").filter(function(d){
										return d.id == data.id;
									}).classed("search-match",true);
									var data = {"pageData":d};
									var item = d3.select(this);
									var elem = d3.select(".tooltip-container-two")
									showTooltip(data,item,elem);
									searchResults.style("display","none");
									mobileTooltipClose = true;
								})
								;

							searchDivData.exit().remove();
						}
						else{
							searchResults.style("display","none");
							d3.select(".second-chart-data").classed("searching",false);
							d3.selectAll(".node-second-chart").classed("search-match",false);
							d3.select(".tooltip-container-two")
							.classed("hidden",true)
							.selectAll(".tooltip-content").remove()
							;

						}
					}

				}
			}

			drawFilters();


	}//for

	// drawCanvas();

}

function voronoiLayout (layoutMode) {

  var xMax = d3.max(data.map(function(d) { return d.layout[layoutMode].x })) + 15;
  var yMax = d3.max(data.map(function(d) { return d.layout[layoutMode].y })) + 15;

  var voronoi = d3.geom.voronoi()
		.x(function(d) {
			var layout = d.layout[layoutMode];
			return layout.x;
		})
		.y(function(d) {
			var layout = d.layout[layoutMode];
			return layout.y;
		})
		.clipExtent([[0, 0], [xMax, yMax]]);

	return voronoi;

}

function updateVoronoi () {

	for(var v = 0; v < visualisations.length; v++){

			var vis = visualisations[v];

			var voronoiGroup = vis.voronoiGroup;
			var clips = vis.clips;

			var layoutMode = "";

			if(v === 0){
				layoutMode = "bubble";
			} else if (v === 1){
				layoutMode = "decade";
			}

			clips
		      .attr('cx', function(d) { return d.layout[layoutMode].x; })
		      .attr('cy', function(d) { return d.layout[layoutMode].y; })
		      .attr('r', 50);

		  $($(".vis-container")[v]).data("layout-mode", layoutMode);


		  // var xMax = d3.max(data.map(function(d) { return d.layout[layoutMode].x })) + 15;
		  // var yMax = d3.max(data.map(function(d) { return d.layout[layoutMode].y })) + 15;

		  // var voronoi = d3.geom.voronoi()
				// .x(function(d) {
				// 	var layout = d.layout[layoutMode];
				// 	return layout.x;
				// })
				// .y(function(d) {
				// 	var layout = d.layout[layoutMode];
				// 	return layout.y;
				// })
				// .clipExtent([[0, 0], [xMax, yMax]]);

		  //$(voronoiGroup).html("");

		  var voronoi = voronoiLayout(layoutMode)


			//Create the Voronoi diagram
			voronoiGroup
				.attr("d", function(d, i) { return "M" + d.join("L") + "Z"; })
				.datum(function(d, i) { return d.point; })
				//Give each cell a unique class where the unique part corresponds to the circle classes
				.attr("class", function(d,i) { return "voronoi " + layoutMode})
				.attr("clip-path", function(d,i) { return "url(#"+layoutMode+"-clip-"+i+")"; })
				.style("stroke", "#2074A0") //I use this to look at how the cells are dispersed as a check
				;

		}

}

function proseShowTooltip(d,item,toolTipContainer) {
	var data = d;

	var tooltipContent = toolTipContainer
		.append("div")
		.attr("class","tooltip-content")
		;
	//

	tooltipContent.append("div")
		.attr("class","tooltip-content-image")
		.style("background-image", function(d, i) {
			if(data.image_url == null || data.image_url == "" || data.image_url == "NULL"){
				return null;
			}
			return "url(http://upload.wikimedia.org/wikipedia/"+data.image_url+")";
		})
		;
	//
	var toolTipText = tooltipContent.append("div")
		.attr("class","tooltip-content-text")
		;
	//
	toolTipText.append("p")
		.attr("class","tooltip-content-text-title")
		.text(function(d,i){
			return data.name;
		})
		;
	//
	toolTipText.append("p")
		.attr("class","tooltip-content-text-sub-title")
		.text(function(d,i){
			return data.subjectRemapping;
		})
		;

	var mentionContainer = toolTipText.append("div")
		.attr("class","tooltip-content-text-mention-container")
		.selectAll("div")
		.data(data.mentionArray)
		.enter()
		.append("div")
		.attr("class","tooltip-content-text-mention")
		;

	mentionContainer.append("p")
		.attr("class","tooltip-content-text-mention-number")
		.text(function(d,i){
			if(d.sectionHeader in sectionKey){
				var sectionTranslate = sectionKey[d.sectionHeader];
				if(sectionTranslate==d.sectionHeader){
					return sectionTranslate;
				}
				return d.sectionHeader +" - " + sectionKey[d.sectionHeader];
			}
			return d.sectionHeader;
		})
		;

	mentionContainer.append("p")
		.attr("class","tooltip-content-text-mention-text")
		.html(function(d,i){
			if(d.quote.length>180){
				var position = d.quote.indexOf("Miles Davis");
				var positionStart = position-90;
				if(positionStart<0){
					positionStart = 0;
					var positionEnd = position+180;
					return d.quote.slice(positionStart,positionEnd).replace("Miles Davis","<span class='highlight-two'>Miles Davis</span>")+"...";
				}
				var positionEnd = position+100;
				var newString = d.quote.slice(positionStart,positionEnd).substring(0,d.quote.slice(positionStart,positionEnd).lastIndexOf(" ")).replace("Miles Davis","<span class='highlight'>Miles Davis</span>")+"...";
				return "..."+newString.substr(newString.indexOf(' ')+1);
			}
			return d.quote.slice(0,180).replace("Miles Davis","<span class='highlight-two'>Miles Davis</span>");
		})
		;

}//function showTooltip

//Show the tooltip on the hovered over circle
function showTooltip(d,item,toolTipContainer) {
	var data = d;

	var secondChart = false;
	if(toolTipContainer.attr("class").indexOf("two") > -1){
		secondChart = true;
	}

	if(toolTipContainer.attr("class").indexOf("one") > -1){

		var tooltipContent = toolTipContainer
			.style("top",function(){
				if(mobile){
					return +data.y+100+"px";
				}
				return +data.y+20+"px";
			})
			.style("left","20px")
			.classed("hidden",false)
			.append("div")
			.attr("class","tooltip-content")
			;

	}
	else{
		var tooltipContent = toolTipContainer
			.style("top",+data.y+300+"px")
			.style("left","20px")
			.classed("hidden",false)
			.append("div")
			.attr("class","tooltip-content")
			;
	}

	var imageAvailable = false;

	if(secondChart){
		if(data.pageData.image_url != null && data.pageData.image_url != "" && data.pageData.image_url != "NULL"){
			imageAvailable = true;
		}
	}
	else{
		if(data.image_url != null && data.image_url != "" && data.image_url != "NULL"){
			imageAvailable = true;
		}
	}

	if(imageAvailable){
		tooltipContent.append("div")
			.attr("class","tooltip-content-image")
			.style("background-image", function(d, i) {
				if(secondChart){
					if(data.pageData.image_url == null || data.pageData.image_url == "" || data.pageData.image_url == "NULL"){
						return null;
					}
					return "url(http://upload.wikimedia.org/wikipedia/"+data.pageData.image_url+")";
				}
				if(data.image_url == null || data.image_url == "" || data.image_url == "NULL"){
					return null;
				}
				return "url(http://upload.wikimedia.org/wikipedia/"+data.image_url+")";
			})
			;
	}

	// //
	var toolTipText = tooltipContent.append("div")
		.attr("class","tooltip-content-text")
		;
	// //
	toolTipText.append("p")
		.attr("class","tooltip-content-text-title")
		.text(function(d,i){
			if(secondChart){
				return data.pageData.name;
			}
			return data.name;
		})
		;
	//
	toolTipText.append("p")
		.attr("class","tooltip-content-text-sub-title")
		.text(function(d,i){
			if(secondChart){
				return data.pageData.subjectRemapping;
			}
			return data.subjectRemapping;
		})
		;

	var mentionContainer = toolTipText.append("div")
		.attr("class","tooltip-content-text-mention-container")
		.selectAll("div")
		.data(function(){
			if(secondChart){
				return data.pageData.mentionArray.slice(0,3);
			}
			return data.mentionArray.slice(0,3);
		})
		.enter()
		.append("div")
		.attr("class","tooltip-content-text-mention")
		;

	mentionContainer.append("p")
		.attr("class","tooltip-content-text-mention-number")
		.text(function(d,i){
			if(d.sectionHeader in sectionKey){
				var sectionTranslate = sectionKey[d.sectionHeader];
				if(sectionTranslate==d.sectionHeader){
					return sectionTranslate;
				}
				return d.sectionHeader +" - " + sectionKey[d.sectionHeader];
			}
			return d.sectionHeader;
		})
		;

	mentionContainer.append("p")
		.attr("class","tooltip-content-text-mention-text")
		.html(function(d,i){
			if(d.quote.length>180){
				var position = d.quote.indexOf("Miles Davis");
				var positionStart = position-90;


				if(positionStart<0){
					positionStart = 0;
					var positionEnd = position+180;
					return d.quote.slice(positionStart,positionEnd).replace("Miles Davis","<span class='highlight-two'>Miles Davis</span>")+"...";
				}
				var positionEnd = position+90;
				var newString = d.quote.slice(positionStart,positionEnd).substring(0,d.quote.slice(positionStart,positionEnd).lastIndexOf(" ")).replace("Miles Davis","<span class='highlight'>Miles Davis</span>")+"...";
				return "..."+newString.substr(newString.indexOf(' ')+1);
			}
			return d.quote.slice(0,180).replace("Miles Davis","<span class='highlight-two'>Miles Davis</span>");
		})
		;

	if(secondChart){
		 if(data.pageData.mentionArray.length > 3){
			 var mentionsRemaining = +data.pageData.mentionArray.length - 3;
			 toolTipText.append("p").attr("class","additional-mentions").html(function(){
				 return "<span style='font-weight:600;'>"+mentionsRemaining + "</span> additional mentions of Miles Davis are viewable on the Wikipedia page..."
			 })
		 }
	}
	else{
		if(data.mentionArray.length > 3){
			console.log("here");
			var mentionsRemaining = +data.mentionArray.length - 3;
			toolTipText.append("p")
				.attr("class","additional-mentions")
				.html(function(){
					return "<span style='font-weight:600;'>"+mentionsRemaining + "</span> additional mentions of Miles Davis are viewable on the Wikipedia page..."
				})
		}
	}


}//function showTooltip

//Hide the tooltip when the mouse moves away
function removeTooltip(d,item,toolTipContainer) {

	// //Hide the tooltip
	// $('.popover').each(function() {
	// 	$(this).remove();
	// });

}//function removeTooltip

function getYear (yearsArray){
	if(yearsArray.length === 0) {
		return null;
	}

	for(var y in yearsArray){
		var matchedYears = yearsArray[y].match(/\d{4}/gi);
    if(matchedYears){
    	var thisMatchedYear = parseInt(matchedYears[0]);
      var thisDecade = (parseInt(thisMatchedYear / 10) * 10);
      if(thisDecade > minYear){
      	return thisMatchedYear;
      }
    }
	}

	return null;

}

var picturePointWidth = 709,
	picturePointHeight = 406;

function drawIntroPicture() {

		d3.selectAll(".star-filler").append("svg")
			.attr("width", "100%")
			.attr("height", "100%")
			.append("g")
			.selectAll("circle")
			.data(d3.range(900))
			.enter()
			.append("circle")
			.attr("fill", function(d,i){
				return "white"
			})
			.attr("cx", function(d){
				return Math.ceil(Math.random()*100)+"%";
			})
			.attr("cy",function(d){
				return Math.ceil(Math.random()*100)+"%";
			})
			.attr("r",function(d){
				return Math.random();
			})
			;

		d3.selectAll(".star-filler-two").append("svg")
			.attr("width", "100%")
			.attr("height", "100%")
			.append("g")
			.selectAll("circle")
			.data(d3.range(1500))
			.enter()
			.append("circle")
			.attr("fill", function(d,i){
				return "white"
			})
			.attr("cx", function(d){
				return Math.random()*100+"%";
			})
			.attr("cy",function(d){
				return Math.random()*100+"%";
			})
			.attr("r",function(d){
				return Math.random();
			})
			;

		if(!mobile){
			d3.selectAll(".intro-vis-miles").append("svg")
				.attr("width", "100%")
				.attr("height", "100%")
				.append("g")
				.selectAll("circle")
				.data(d3.range(600))
				.enter()
				.append("circle")
				.attr("fill", function(d,i){
					return "white"
				})
				.attr("cx", function(d){
					return Math.random()*100+"%";
				})
				.attr("cy",function(d){
					return Math.random()*100+"%";
				})
				.attr("r",function(d){
					return Math.random();
				})
				;
		}

		if(mobile){
			var svgTwo = d3.select(".intro-vis-miles")
				.append("svg")
				.attr("width", picturePointWidth)
				.attr("height", picturePointHeight)
				.attr("class", "picture-point")
				;

			var dotPlot = svgTwo.append("g")
			  .selectAll("circle")
			  .data(pictureCoords)
			  .enter()
				.append("circle")
			  .attr("class", function(d,i){
					if(d["radius"]> 1){
			      return "dot-plot circle-plot";
			    }
			    else if(Math.random()>.4){
			      return "dot-plot circle-plot"
			    }
			    // else if(Math.random()>.5){
					// 	return "circle-plot"
					// 	// return "dot-plot-two circle-plot"
			    // }
					return "circle-plot"
			  })
			  .attr("cx", function(d){
			    return d["cx"];
			  })
			  .attr("cy",function(d){
			    return d["cy"];
			  })
			  .attr("r",function(d){
			    return d["radius"]
			  })
				;
		}


		var dotPlotDots = d3.selectAll(".dot-plot");

		// dotPlotDots
		// 	.transition()
		// 	.duration(5000)
		// 	.delay(function(d,i){
		// 		return Math.random()*5000;
		// 	})
		// 	.attr("r",0)
		// 	.transition()
		// 	.duration(5000)
		// 	.delay(function(d,i){
		// 		return Math.random()*5000 + 8000;
		// 	})
		// 	.attr("r",function(d,i){
		// 		return d[2];
		// 	})
		// 	;

		function twinkle(){
		  setInterval(function(){
		    dotPlotDots
		      .transition()
		      .duration(5000)
		      .delay(function(d,i){
		        return Math.random()*5000;
		      })
		      .attr("r",0)
		      .transition()
		      .duration(5000)
		      .delay(function(d,i){
		        return Math.random()*5000 + 8000;
		      })
		      .attr("r",function(d,i){
		        return d[2];
		      })
		      ;
		  }, 18000);
		}

		// twinkle();

}

$(document).ready(function() {

	var milesPageIdMap = d3.nest().key(function(d) {
			return d.id;
		})
		.entries(milesPagesData)
		;

	var milesPageUrlMap = d3.nest().key(function(d) {
			return d.URL;
		})
		.entries(milesPagesData)
		;

	milesPageUrlKey = d3.map(milesPageUrlMap,function(d){
		return d.key
	})
	;

	milesPageIdKey = d3.map(milesPageIdMap,function(d){
		return d.key
	})
	;

	var milesMentionNest = d3.nest().key(function(d) {
			return d.id;
		})
		.entries(milesMentionsData)
		;

	var milesMentionKey = d3.map(milesMentionNest,function(d){
		return d.key
	})
	;

	var entityTypeMapping = {"musicians":"people","people":"people","recording":"recording","events":"other","places":"places","genres":"other","films":"other","books":"other","works":"other","other":"other"};
	var entityTypeRank = {"people":10,"recording":9,"places":8,"other":1};

	entityTypeCounts = d3.nest().key(function(d) {
			return entityTypeMapping[d.subjectRemapping];
		})
		.rollup(function(leaves) { return leaves.length; })
		.entries(milesPagesData)
		;

	for (var type in entityTypeCounts){
		entityTypeCounts[type].order = entityTypeRank[entityTypeCounts[type].key];
	}

	entityTypeCounts = entityTypeCounts.sort(function(b, a){
		var o1 = a.order;
		var o2 = b.order;

		if (o1 < o2) return -1;
		if (o1 > o2) return 1;
		return 0;
		})
		;

	var milesPagesKey = d3.map(milesPages,function(d){
		return d;
	})
	;

	for (var page in milesPagesData){
		milesPagesData[page].mentionArray = milesMentionKey.get(milesPagesData[page].id).values;
		if(milesPagesKey.has(milesPagesData[page].id)){
			milesPagesData[page].linked_from_miles = true;
		}
		else{
			milesPagesData[page].linked_from_miles = false;
		}
	}

	drawIntroPicture();

	drawDataBinding();

	function drawThirdChart(){

		var influenceCountNumber = 0;
		var pageViewNonCountNumber = 0;
		var pageViewCut = 50000;

		var thirdData = milesPagesData.filter(function(d,i){
			var itemSectionArray = d.mentionArray;
			var mentionItem = 0;
			var match = 0;
			for (var section in itemSectionArray){

				var sectionName = itemSectionArray[section].sectionHeader
				if(sectionName in sectionKey){
					sectionName = sectionKey[itemSectionArray[section].sectionHeader];
				}
				if(sectionName == "influence"){
					mentionItem = section;
					match = 1;
				};
			}
			d.mentionItem = mentionItem;

			if(match==1){
				influenceCountNumber++;
				if (d.subjectRemapping == "musicians" || d.subjectRemapping == "people" || d.subjectRemapping == "recording"){
					match = 1
				}
				else{
					match = 0;
				}
			}

			if (+d.pageViews > pageViewCut && match == 1){
				match = 1
			}
			else if (+d.pageViews < pageViewCut && match == 1){
				pageViewNonCountNumber++;
				match = 0;
			}
			return match == 1
		})
		;

		thirdData = thirdData.filter(function(d){
			return d.year != "" && d.year != null && +d.year > 1934;
		})
		;

		d3.select(".third-chart-count").text(commaFormat(influenceCountNumber));
		d3.select(".third-obscure").text(commaFormat(pageViewNonCountNumber));
		d3.select(".third-page-cut").text(commaFormat(pageViewCut));

		var thirdChartShadowContainer = d3.select(".third-shadow-container");

		// var yearRandom = d3.scale.linear().domain([0,1]).range([1940,2016])

		// thirdData = thirdData.slice(0,10);

		var thirdDataYearNest = d3.nest().key(function(d) {
			if(mobile){
				if(d.year%2 != 0){
					return +d.year+1;
				}
				return d.year;
			}
			return d.year;
		})
		.entries(thirdData)
		;

		var minYear = d3.min(thirdDataYearNest, function(d) { return +d.key });
		var maxYear = d3.max(thirdDataYearNest, function(d) { return +d.key });
		var maxCount = d3.max(thirdDataYearNest, function(d) { return +d.values.length });
		var chartHeight = maxCount*6;
		var thirdDataObject = [];
		var width = (maxYear-minYear)*8

		var offset = (950-width)/2;

		if(mobile){
			width = viewportWidth*.90;
			offset = viewportWidth*.1/2;
		}

		var count = 0;
		var itemWidth = 139;
		if(mobile){
			itemWidth = 100;
		}

		for (var year in thirdDataYearNest){
			var yearData = thirdDataYearNest[year].key;
			var xPos = 8*(thirdDataYearNest[year].key - minYear)+offset;
			if(mobile){
				var xPos = 8*(thirdDataYearNest[year].key - minYear)/2+offset;
			}
			var yPos;
			var id;
			var nestCount;

			for (page in thirdDataYearNest[year].values){
				id = thirdDataYearNest[year].values[page].id
				nestCount = count++;
				yPos = chartHeight - page*6;
				thirdDataObject.push({x:xPos,y:yPos,id:id,pageData:milesPageIdKey.get(id).values[0],nestCount:nestCount})
			}
		}

		d3.select(".third-data-length").text(commaFormat(thirdDataObject.length))

		if(!mobile){
			var baseDataShadow = thirdChartShadowContainer.append("div")
				.attr("class","third-chart-shadow")
				.style("height",maxCount*6+10+"px")
				.selectAll("div")
				.data(thirdDataObject)
				.enter()
				.append("div")
				.attr("class","third-data-node-shadow")
				.style("left",function(d,i){
					return d.x+"px";
				})
				.style("top",function(d,i){
					return d.y+"px";
				})
				.on("click",function(d){
				})
				;


			var thirdChartShadow = d3.select(".third-chart-shadow").append("div")
				.attr("class","third-chart-axis")
				.style("width",function(){
					if(mobile){
						return width+"px";
					}
					return width*1.02+"px";
				})
				;

			thirdChartShadow.append("p")
				.attr("class","third-chart-axis-item third-chart-axis-item-start")
				.text("1935")
				;

			thirdChartShadow.append("p")
				.attr("class","third-chart-axis-item third-chart-axis-item-end")
				.text("2016")
				;
		}

		var thirdDataNest = d3.nest().key(function(d,i) {
				if(mobile){
					return Math.floor(d.nestCount/3);
				}
				return Math.floor(d.nestCount/6);
  		})
  		.entries(thirdDataObject)
			;

		var chartThreeProseSub = d3.select(".third-chart-prose");

		var container = d3.select(".third-chart-circle-container-one")

		var baseDataBindWapper = container.append("div")
			.attr("class","third-chart-data")
			.selectAll("div")
			.data(thirdDataNest)
			.enter()
			.append("div")
			.attr("class",function(d,i){
				if(i==0){
					return "third-data-row third-data-freeze";
				}
				return "third-data-row";
			})
			;

		var baseDataBind = baseDataBindWapper
			.selectAll("div")
			.data(function(d){
				return d.values;
			})
			.enter()
			.append("div")
			.attr("class","third-data-node")
			.style("width",itemWidth+"px")
			.style("left",function(d,i){
				if(mobile){
					// if(i==0){
					// 	return 15+"px";
					// }
					// return i*130+"px";
					return null;
				}
				return i*160+"px";
			})
			.style("top",function(d,i){
				if(mobile){
					return null;
				}
				return chartHeight+"px";
			})
			;
		//

		if(!mobile){

			var pinChartShadow = new ScrollMagic.Scene({
					// triggerElement: ".third-chart-wrapper",
					triggerElement: ".third-shadow-container",
					triggerHook:0,
					offset: -30,
					duration:(315*thirdDataNest.length+50)
				})
				// .addIndicators({name: "pin 3 chart"}) // add indicators (requires plugin)
				.setPin(".third-chart-shadow", {pushFollowers: false})
				.addTo(controller)
				.on("enter",function(e){
					if(e.target.controller().info("scrollDirection") == "REVERSE"){
						d3.selectAll(".third-data-row").style("opacity",1);
					};
				})
				.on("leave",function(e){
					if(e.target.controller().info("scrollDirection") == "FORWARD"){
						d3.selectAll(".third-data-row").style("opacity",0);
					};
				})
				;
		}

		var objBubble = baseDataBind.append("div")
			.attr("class","third-section-item-bubble")
			.style("background-image", function(d, i) {
				if(d.pageData.image_url==null || d.pageData.image_url=="NULL" || d.pageData.image_url==""){
					return null;
				}
				return "url(http://upload.wikimedia.org/wikipedia/"+d.pageData.image_url+")";
			})
			.on("click",function(d){
				if(!mobile){
					window.open("https://en.wikipedia.org/wiki/"+d.pageData.URL, '_blank');
				}
				else{
					window.location.href = "https://en.wikipedia.org/wiki/"+d.pageData.URL;
				}
			})
			;

		var objTitle = baseDataBind
			.append("a")
			.attr("href",function(d){
				return "https://en.wikipedia.org/wiki/"+d.pageData.URL;
			})
			.append("p")
			.attr("class","third-section-item-title")
			.text(function(d){
				return d.pageData.name;
			})
			;

		var objDesc = baseDataBind.append("p")
			.attr("class","third-section-item-text")
			.html(function(d){
				if(d.pageData.mentionArray[d.pageData.mentionItem].quote.length>220){
					var position = d.pageData.mentionArray[d.pageData.mentionItem].quote.indexOf("Miles Davis");
					var positionStart = position-110;
					if(positionStart<0){
						positionStart = 0;
						var positionEnd = position+220;
						return d.pageData.mentionArray[d.pageData.mentionItem].quote.slice(positionStart,positionEnd).replace("Miles Davis","<span class='highlight'>Miles Davis</span>").substring(0, d.pageData.mentionArray[d.pageData.mentionItem].quote.slice(positionStart,positionEnd).lastIndexOf(" ") + 1)+"...";
					}
					var positionEnd = position+110;
					var newString = d.pageData.mentionArray[d.pageData.mentionItem].quote.slice(positionStart,positionEnd).substring(0,d.pageData.mentionArray[d.pageData.mentionItem].quote.slice(positionStart,positionEnd).lastIndexOf(" ")).replace("Miles Davis","<span class='highlight'>Miles Davis</span>")+"...";
					;
					return "..."+newString.substr(newString.indexOf(' ')+1);
				}
				return d.pageData.mentionArray[d.pageData.mentionItem].quote.slice(0,220).replace("Miles Davis","<span class='highlight'>Miles Davis</span>");
			})
			;
		//
		var circleSizeScale = d3.scale.linear().domain([1,0]).range([5,40]);

		if(!mobile){
			$(".third-data-row").each(function(i, c) {

				// if(!mobile){

					var pinChartThird = new ScrollMagic.Scene({
							triggerElement: c,
							triggerHook:0,
							offset:-100
							// ,duration:(thirdDataNest.length-i)*300
						})
						// .addIndicators({name: "transition 3 pin"}) // add indicators (requires plugin)
						.setPin(c, {pushFollowers: false})
						.addTo(controller)
						;
					var moveChartThird = new ScrollMagic.Scene({
							triggerElement: c,
							triggerHook:0,
							offset:-100,
							duration:300
						})
						// .addIndicators({name: "transition 3 section"}) // add indicators (requires plugin)
						.addTo(controller)
						.on("enter",function(e){
							if(e.target.controller().info("scrollDirection") == "FORWARD"){
								var objDesc = d3.select(c).selectAll("div").select(".third-section-item-text");
								var objBubble = d3.select(c).selectAll("div").select("div");
								var objTitle = d3.select(c).selectAll("div").select(".third-section-item-title");
								//
								objDesc.transition().duration(100).style("opacity",0);
								objBubble
									.transition().duration(300).style("width",2+"px").style("height",2+"px")
									;
								objTitle.transition().duration(100).style("opacity",0);
							};
						})
						.on("leave",function(e){
							if(e.target.controller().info("scrollDirection") == "REVERSE"){
								var objDesc = d3.select(c).selectAll("div").select(".third-section-item-text");
								var objBubble = d3.select(c).selectAll("div").select("div");
								var objTitle = d3.select(c).selectAll("div").select(".third-section-item-title");

								objDesc.transition().duration(100).style("opacity",1);
								objBubble
									.transition().duration(300).style("width",40+"px").style("height",40+"px")
									;
								objTitle.transition().duration(100).style("opacity",1);
							}
						})
						.on("progress", function (e) {
							var progress = e.progress;

							d3.select(c).selectAll(".third-data-node")
								.style("left",function(d,count){
									var pointOne;
									var pointTwo;
									pointOne = 160 * count;
									if(mobile){
										if(count==0){
											pointOne = 15;
										}
										else{
											pointOne = count*130;
										}
									}
									pointTwo = d.x - (itemWidth/2) + 2;
									var scale = d3.scale.linear().domain([0,1]).range([pointOne,pointTwo]).clamp(true);
									return scale(progress)+"px";
								})
								.style("top",function(d,i){
									var pointOne;
									var pointTwo;
									pointOne = chartHeight;
									pointTwo = d.y - 70;
									var scale = d3.scale.linear().domain([0,1]).range([pointOne,pointTwo]).clamp(true);
									return scale(progress)+"px";
								})
								;
						})
						;
					// }
			})
			;
		}
	}

	drawThirdChart();

	function canvasDrawThing(nodes){

		var width = 709;
		var height = 406;

		// if(mobile){
		// 	var canvas = document.querySelector("canvas"),
		// 	context = canvas.getContext("2d"),
		// 	width = canvas.width,
		// 	height = canvas.height;
		//
		// 	context.fillStyle = "white";
		// 	context.clearRect(0, 0, width, height);
		// 	context.beginPath();
		// 	for (i = 0; i < nodes.length; ++i) {
		// 		d = nodes[i];
		// 		x = d.cx
		// 		y = d.cy
		// 		r = d.radius;
		// 		context.moveTo(d.cx, d.cy);
		// 		context.arc(x, y, r, 0, 2 * Math.PI);
		// 	}
		// 	context.fill();
		// }

		if(!mobile){
			function shuffle(array) {
				var currentIndex = array.length, temporaryValue, randomIndex;

				// While there remain elements to shuffle...
				while (0 !== currentIndex) {

					// Pick a remaining element...
					randomIndex = Math.floor(Math.random() * currentIndex);
					currentIndex -= 1;

					// And swap it with the current element.
					temporaryValue = array[currentIndex];
					array[currentIndex] = array[randomIndex];
					array[randomIndex] = temporaryValue;
				}

				return array;
			}

			nodes = shuffle(nodes);

			var canvas = document.querySelector("canvas"),
			context = canvas.getContext("2d"),
			width = canvas.width,
			height = canvas.height;

			context.fillStyle = "white";
			context.clearRect(0, 0, width, height);
			context.beginPath();
			for (i = 0; i < nodes.length; ++i) {
				d = nodes[i];
				x = d.cx
				y = d.cy
				r = d.radius;
				context.moveTo(d.cx, d.cy);
				if(i % 6 == 0){
					context.arc(x, y, r, 0, 2 * Math.PI);
				}
			}
			context.fill();

			var forward = true;

			function shiftCircles(){
				d3.select({}).transition()
						.duration(7000)
						.delay(1000)
						.ease(Math.sqrt)
						.tween("circle", function() {
							return function(t) {

								var threshold = t*nodes.length;
								context.clearRect(0, 0, width, height);
								context.beginPath();
								for (i = 0; i < nodes.length; ++i) {
									d = nodes[i];
									x = d.cx
									y = d.cy
									r = d.radius;
									context.moveTo(d.cx, d.cy);
									if(i % 6 == 0){
										context.arc(x, y, r, 0, 2 * Math.PI);
									}
									else if(i < threshold && forward){
										var position = i/nodes.length;
										var tweenLength = 1-position;
										var percentTime = (t-position)/tweenLength;
										// console.log(position,tweenLength,percentTime);
										var radius = percentTime*r

										if (radius > r){
											radius = r;
										}
										context.arc(x, y, radius, 0, 2 * Math.PI);
									}
									else if(i<threshold && !forward){
										var position = i/nodes.length;
										var tweenLength = 1-position;
										var percentTime = (t-position)/tweenLength;
										// console.log(position,tweenLength,percentTime);
										var radius = r - (percentTime*r)

										if (radius < 0){
											radius = 0;
										}
										context.arc(x, y, radius, 0, 2 * Math.PI);
									}
									else{
										if(forward){
											context.arc(x, y, 0, 0, 2 * Math.PI);
										}
										else if(!forward){
											context.arc(x, y, r, 0, 2 * Math.PI);
										}
									}
								}
								context.fill();
							};
						});
			}

			var introInterval = window.setInterval(function(){
				if(forward){
					forward = false;
				}
				else{
					forward = true;
				}
				shiftCircles();
			}, 13000);
			shiftCircles();

			var canvasShutDown = new ScrollMagic.Scene({
					triggerElement: ".intro-miles-canvas",
					duration:150,
					triggerHook:0,
					offset:0
				})
				// .addIndicators({name: "milespage"}) // add indicators
				.addTo(controller)
				.on("enter", function (e) {
					if(e.target.controller().info("scrollDirection") == "REVERSE"){
						forward = false;
						shiftCircles();
						introInterval = window.setInterval(function(){
							if(forward){
								forward = false;
							}
							else{
								forward = true;
							}
							shiftCircles();
						}, 13000);
					}
				})
				.on("leave",function(e){
					if(e.target.controller().info("scrollDirection") == "FORWARD"){
						window.clearInterval(introInterval)
					}
				})
				;
		}



	}


	if(!mobile){
		canvasDrawThing(canvasObject);
	}

	var layoutFinished = false;

	if(!mobile){
		var layoutFistChart = new ScrollMagic.Scene({
				triggerElement: ".trigger-first-layout-change",
				duration:500,
				triggerHook:1,
				offset:0
			})
			// .addIndicators({name: "layout change"}) // add indicators
			.addTo(controller)
			.on("enter", function (e) {

				if (!layoutFinished){
					d3.selectAll(".first-chart-nodes").transition().duration(1000)
						.delay(function(d,i){
							return i*.8;
						})
						.attr("cx",function(d){
							return (+d.x2 - 70);
						})
						.attr("cy",function(d){
							return (+d.y2+50);
						})
						;

					d3.selectAll(".first-chart-text")
						.attr("x", function(d, i) {
							// if(d.name.split(" ").length<2){
								return (+d.x2 - 70);
							// }
							// return null;
						})
						.attr("y", function(d, i) {
							return (+d.y2+50);
						})
						.html(function(d){
							if(d.name.split(" ").length>1){
								return "<tspan x="+(+d.x2 - 70)+" text-anchor='middle'>"+d.name.split(" ")[0]+"</tspan><tspan x="+(+d.x2 - 70)+" text-anchor='middle' dy='1.1em'>"+d.name.split(" ")[1]+"</tspan>"
							}
							return d.name;
						})
						;
				}
			})
			.on("leave",function(e){
				if (!layoutFinished){
					if(e.target.controller().info("scrollDirection") == "FORWARD"){
						d3.selectAll(".first-chart-nodes").transition().duration(2000)
							.delay(function(d,i){
								return i*1.2;
							})
							.attr("cx",function(d){
								return (+d.x - 70);
							})
							.attr("cy",function(d){
								return d.y;
							})
							;

						d3.selectAll(".first-chart-text")
							.attr("x", function(d, i) {
								// if(d.name.split(" ").length<2){
									return (+d.x - 70);
								// }
								// return null;
							})
							.attr("y", function(d, i) {
								return +d.y;
							})
							.html(function(d){
								if(d.name.split(" ").length>1){
									return "<tspan x="+(+d.x - 70)+" text-anchor='middle'>"+d.name.split(" ")[0]+"</tspan><tspan x="+(+d.x - 70)+" text-anchor='middle' dy='1.1em'>"+d.name.split(" ")[1]+"</tspan>"
								}
								return d.name;
							})
							;

							layoutFinished = true;

						}
					}
			})
			;

		var milesLink = new ScrollMagic.Scene({
				triggerElement: ".first-chart-prose-miles-page",
				duration:150,
				triggerHook:.5,
				offset:-50
			})
			// .addIndicators({name: "milespage"}) // add indicators
			.addTo(controller)
			.on("enter", function (e) {
						// d3.select(".first-chart-prose-miles-page").transition().duration(500).style("color","#f33");
						d3.select(".first-chart-data").classed("filtered-miles-work",true);
						d3.select(".red-highlight").transition().duration(500).style("opacity",1)
			})
			.on("leave",function(e){
						// d3.select(".first-chart-prose-miles-page").transition().duration(0).style("color","#fff");
						d3.select(".first-chart-data").classed("filtered-miles-work",false);
						d3.select(".red-highlight").transition().duration(0).transition().duration(500).style("opacity",0)
			})
			;

		var peopleCategory = new ScrollMagic.Scene({
				triggerElement: ".trigger-people-change",
				duration:150,
				triggerHook:.5,
				offset:0
			})
			// .addIndicators({name: "milespage"}) // add indicators
			.addTo(controller)
			.on("enter", function (e) {
						// d3.select(".first-chart-prose-miles-page").transition().duration(500).style("color","#f33");
						d3.select(".first-chart-data").classed("filtered-people-subject",true);
						d3.select(".first-chart-filters").selectAll(".first-chart-filter").classed(".highlighted-filter",false);
						d3.select(".first-chart-filters").select(".people-subject").classed(".highlighted-filter",true);
			})
			.on("leave",function(e){
				if(e.target.controller().info("scrollDirection") == "FORWARD"){
					d3.select(".first-chart-data").classed("filtered-people-subject",false).classed("filtered-recordings-subject",true);
					d3.select(".first-chart-filters").selectAll(".first-chart-filter").classed(".highlighted-filter",false);
					d3.select(".first-chart-filters").select(".recordings-subject").classed(".highlighted-filter",true);
				}
				else{
					d3.select(".first-chart-data").classed("filtered-people-subject",false).classed("filtered-recordings-subject",false);
					d3.select(".first-chart-filters").selectAll(".first-chart-filter").classed(".highlighted-filter",false);
				}
			})
			;

		var otherCategory = new ScrollMagic.Scene({
				triggerElement: ".trigger-other-change",
				duration:150,
				triggerHook:.5,
				offset:0
			})
			// .addIndicators({name: "milespage"}) // add indicators
			.addTo(controller)
			.on("enter", function (e) {
						// d3.select(".first-chart-prose-miles-page").transition().duration(500).style("color","#f33");
						d3.select(".first-chart-data").classed("filtered-other-subject",true).classed("filtered-recordings-subject",false);
						d3.select(".first-chart-filters").selectAll(".first-chart-filter").classed(".highlighted-filter",false);
						d3.select(".first-chart-filters").select(".other-subject").classed(".highlighted-filter",true);
			})
			.on("leave",function(e){
				if(e.target.controller().info("scrollDirection") == "FORWARD"){
					d3.select(".first-chart-data").classed("filtered-recordings-subject",false).classed("filtered-other-subject",false);
					d3.select(".first-chart-filters").selectAll(".first-chart-filter").classed(".highlighted-filter",false);
				}
				else{
					d3.select(".first-chart-data").classed("filtered-recordings-subject",true).classed("filtered-other-subject",false);
					d3.select(".first-chart-filters").selectAll(".first-chart-filter").classed(".highlighted-filter",false);
					d3.select(".first-chart-filters").select(".recordings-subject").classed(".highlighted-filter",true);
				}
			})
			;
	}


	if(!mobile){
		$(".vis-container").each(function(i, c) {

			var pinOffset = -20;
			var pinDuration = 900;

			if(i === 1){
				pinOffset = -20;
				pinDuration = 600;
			}

			var pinChart = new ScrollMagic.Scene({
					triggerElement: ".trigger-" + (i + 1),
					triggerHook:0,
					offset: pinOffset,
					duration: pinDuration
				})
				// .addIndicators({name: "pin " + i + " chart"}) // add indicators (requires plugin)
				.setPin("#vis-" + (i + 1))
				.addTo(controller)
				;
		});
	}



	d3.selectAll(".prose-link")
		.on("mouseover",function(){
			if(!proseLinkContainer && !mobile){
				var pageUrl = d3.select(this).attr("href").replace("https://en.wikipedia.org/wiki/","");
				var dataElement = milesPageUrlKey.get(pageUrl).values[0];
				var item = d3.select(this);
				var elem = d3.select(this.parentNode).append("div").style("left","20px").style("top",(item.node().offsetTop+50)+"px").attr("class","tooltip-container tk-neuzeit-grotesk tooltip-prose");
				var data = dataElement;
				proseShowTooltip(data,item,elem);
				proseLinkContainer = true;
			}
		})
		.on("mouseout",function(){
			proseLinkContainer = false;
			d3.selectAll(".tooltip-prose").remove();
		})
		;

		d3.selectAll(".total-page-count").text(function(){
			return commaFormat(milesPagesData.length);
		})
		;

		d3.selectAll(".miles-linked-page").text(function(){
			return commaFormat(data.filter(function(d){
				return d.linked_from_miles == true;
			}).length);
		})
		;

		d3.selectAll(".miles-works-page").text(function(){
			return percentFormat(data.filter(function(d){
				return d.miles_work == true;
			}).length/data.length);
		})
		;

})


//miles load
});
//miles load
});
//miles load
});
function save(){

  csvContent = "data:text/csv;charset=utf-8,";
  scriptCsv.forEach(function(infoArray, index){
     dataString = infoArray.join(",");
     csvContent += dataString + "\n";
  });
}
